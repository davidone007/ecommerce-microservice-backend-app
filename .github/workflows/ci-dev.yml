name: CI - Dev build

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [dev, "feat/*", "ops/feat/*"]
  pull_request:
    branches: [dev, "feat/*", "ops/feat/*"]

jobs:
  maven-build:
    name: Build (Maven)
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Deshabilitado completamente para self-hosted runners
      # El cachÃ© local de Maven en ~/.m2 ya es persistente en self-hosted
      # - name: Cache Maven local repository
      #   if: runner.environment != 'self-hosted'
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.m2/repository
      #     key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
      #     restore-keys: |
      #       ${{ runner.os }}-m2-

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"
          # No usar cache en self-hosted para evitar timeouts

      - name: Build with Maven (run unit tests)
        run: |
          chmod +x ./mvnw
          ./mvnw test jacoco:report -Dtest="*ServiceImplTest"

      - name: Ensure SonarQube available (start local if missing)
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # If secrets not configured, skip starting local Sonar and the check will be performed later by the Sonar step
          if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
            echo "SONAR_HOST_URL or SONAR_TOKEN not set; skipping Sonar availability check/startup"
            exit 0
          fi

          echo "Checking SonarQube at $SONAR_HOST_URL"
          if curl -sSf --max-time 5 "$SONAR_HOST_URL" >/dev/null 2>&1; then
            echo "SonarQube is reachable"
            exit 0
          fi

          echo "SonarQube not reachable. Attempting to start local Sonar using docker-compose.sonar.yml"
          # Try docker compose (modern) then docker-compose (legacy)
          if command -v docker >/dev/null 2>&1; then
            if command -v docker-compose >/dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker-compose"
            else
              DOCKER_COMPOSE_CMD="docker compose"
            fi
            echo "Using: $DOCKER_COMPOSE_CMD"
            # Start Sonar stack from repo root
            $DOCKER_COMPOSE_CMD -f docker-compose.sonar.yml up -d
          else
            echo "Docker not available on runner; cannot start local Sonar. Proceeding and letting Sonar analysis step handle unreachable host."
            exit 0
          fi

          # wait for Sonar to become healthy (timeout 180s)
          SECONDS_WAITED=0
          until curl -sSf --max-time 5 "$SONAR_HOST_URL" >/dev/null 2>&1 || [ $SECONDS_WAITED -ge 180 ]; do
            sleep 5
            SECONDS_WAITED=$((SECONDS_WAITED+5))
            echo "Waiting for SonarQube... ($SECONDS_WAITED s)"
          done

          if curl -sSf --max-time 5 "$SONAR_HOST_URL" >/dev/null 2>&1; then
            echo "SonarQube is up after startup"
          else
            echo "Timed out waiting for SonarQube to start. Proceeding and letting Sonar analysis step run (it may fail)."
          fi

      - name: SonarQube analysis
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # If secrets are not configured, skip Sonar analysis so CI won't fail.
          if [ -z "$SONAR_HOST_URL" ] || [ -z "$SONAR_TOKEN" ]; then
            echo "Skipping SonarQube analysis: SONAR_HOST_URL or SONAR_TOKEN not set as secrets"
            exit 0
          fi

          chmod +x ./mvnw
          # Run Sonar analysis using Maven Sonar plugin. For multi-module projects the plugin
          # will analyze modules from the root pom. The aggregated JaCoCo XML is passed to Sonar.
          ./mvnw -B -DskipTests=true sonar:sonar \
          -Dsonar.host.url="$SONAR_HOST_URL" \
          -Dsonar.login="$SONAR_TOKEN" \
          -Dsonar.projectKey="ecommerce" \
          -Dsonar.projectName="ecommerce" \
          -Dsonar.coverage.jacoco.xmlReportPaths="**/target/site/jacoco/jacoco.xml,**/target/site/jacoco-aggregate/jacoco.xml"

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
          retention-days: 3

      - name: Upload build workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: |
            .
            !.git
          retention-days: 1

  docker-build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: maven-build
    strategy:
      fail-fast: false
      matrix:
        service:
          [
            api-gateway,
            cloud-config,
            favourite-service,
            order-service,
            payment-service,
            product-service,
            proxy-client,
            service-discovery,
            shipping-service,
            user-service,
          ]

    steps:
      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - name: Check if Dockerfile exists
        id: check
        run: |
          if [ -f "${{ matrix.service }}/Dockerfile" ]; then 
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else 
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      # NOTE: removed conditional push decision; images will be pushed for all branches/PRs with tag 'dev'

      - name: Log in to GHCR
        if: steps.check.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Using fixed tag 'dev' for all pushed images

      - name: Extract metadata
        if: steps.check.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=,format=long
            # Add a fixed tag 'dev' for all pushes
            type=raw,value=dev

      - name: Build and push
        if: steps.check.outputs.exists == 'true' && (github.event_name == 'push' && github.ref == 'refs/heads/dev' || github.event_name == 'pull_request' && github.base_ref == 'dev')
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
