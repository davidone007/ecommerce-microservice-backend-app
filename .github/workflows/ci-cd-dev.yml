name: CI - CD - Dev build

permissions:
  contents: write
  packages: write

on:
  # Run this workflow on any branch except master and stage (both on push and PRs)
  push:
    branches-ignore: [master, stage]
  pull_request:
    branches-ignore: [master, stage]

jobs:
  maven-build:
    name: Build (Maven)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Deshabilitado completamente para self-hosted runners
      # El cach√© local del Maven en ~/.m2 ya es persistente en self-hosted
      # - name: Cache Maven local repository
      #   if: runner.environment != 'self-hosted'
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.m2/repository
      #     key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
      #     restore-keys: |
      #       ${{ runner.os }}-m2-

      - name: Set up JDK 11 and 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: |
            11
            17

      - name: Build with Maven (run unit tests)
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_11_X64 }}
        run: |
          echo "Building with Java 11"
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          chmod +x ./mvnw
          # Run unit tests. Some modules may not have tests matching the pattern
          # and would cause Maven Surefire to fail the build. Add -DfailIfNoTests=false
          # so that modules without matching tests don't fail the aggregated build.
          ./mvnw -B -T 1C verify -Dtest="*ServiceImplTest" -DfailIfNoTests=false

      - name: SonarQube analysis
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
        run: |
          # Check if secrets are set and not empty
          if [ -z "$SONAR_TOKEN" ] || [ -z "$SONAR_HOST_URL" ]; then
            echo "‚ö†Ô∏è  SONAR_HOST_URL or SONAR_TOKEN not set; skipping SonarQube analysis"
            exit 0
          fi

          # Validate that SONAR_HOST_URL has proper scheme (http:// or https://)
          if [[ ! "$SONAR_HOST_URL" =~ ^https?:// ]]; then
            echo "‚ö†Ô∏è  SONAR_HOST_URL does not start with http:// or https://; skipping SonarQube analysis"
            echo "   Current value: '$SONAR_HOST_URL'"
            echo "   Please update the secret to include the proper URL scheme (e.g., https://sonarqube.example.com)"
            exit 0
          fi

          echo "‚û°Ô∏è Running SonarQube analysis against $SONAR_HOST_URL"
          echo "   JAVA_HOME: $JAVA_HOME"
          echo "   Java version: $(java -version 2>&1 | head -n 1)"
          echo "   Maven Java version: $(./mvnw --version | grep 'Java version')"
          
          chmod +x ./mvnw
          ./mvnw -B -DskipTests=true sonar:sonar \
            -Dsonar.host.url="$SONAR_HOST_URL" \
            -Dsonar.login="$SONAR_TOKEN" \
            -Dsonar.projectKey="ecommerce" \
            -Dsonar.projectName="ecommerce" \
            -Dsonar.coverage.jacoco.xmlReportPaths="**/target/site/jacoco/jacoco.xml,**/target/site/jacoco-aggregate/jacoco.xml"

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
          retention-days: 3

      - name: Upload build workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: |
            .
            !.git
          retention-days: 1

  calculate-semver:
    name: Calculate Semantic Version (Dev)
    runs-on: ubuntu-latest
    needs: maven-build
    outputs:
      new_version: ${{ steps.calc.outputs.new_version }}
      changelog: ${{ steps.calc.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Semantic Version & Changelog (dry run)
        id: calc
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: dev
          tag_prefix: dev-
          dry_run: true
          default_bump: minor

  docker-build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: [maven-build, calculate-semver]
    strategy:
      fail-fast: false
      matrix:
        service:
          [
            api-gateway,
            cloud-config,
            favourite-service,
            order-service,
            payment-service,
            product-service,
            proxy-client,
            service-discovery,
            shipping-service,
            user-service,
          ]

    steps:
      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - name: Check if Dockerfile exists
        id: check
        run: |
          if [ -f "${{ matrix.service }}/Dockerfile" ]; then 
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else 
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        # Only login for push events to dev (where we push images)
        if: steps.check.outputs.exists == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/dev'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Images are pushed only on direct pushes to dev (after merge)
      # PRs and feature branches will build images to verify they compile but won't push them

      - name: Extract metadata
        if: steps.check.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}
          tags: |
            # Add semantic version (calculated earlier) if available
            type=raw,value=${{ needs.calculate-semver.outputs.new_version }}
            type=raw,value=latest
            type=sha,prefix=,format=long
            # Add a fixed tag 'dev' for all pushes
            type=raw,value=dev

      - name: Build and push
        # Only push images on direct pushes to dev (after merge)
        if: steps.check.outputs.exists == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/dev'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build only (for PRs and Feature Branches)
        # Build images for PRs or feature branches without pushing
        if: steps.check.outputs.exists == 'true' && (github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/dev'))
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Trivy vulnerability scanner (report CRITICAL as warnings)
        if: steps.check.outputs.exists == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/dev'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}:${{ needs.calculate-semver.outputs.new_version }}
          format: table
          # Treat CRITICAL vulnerabilities as warnings for Dev builds ‚Äî do not fail the pipeline.
          # Set exit-code: 0 so the step never returns a failing exit code regardless of findings.
          exit-code: 0
          ignore-unfixed: false
          vuln-type: os,library
          # Fail build only for CRITICAL vulns here; HIGH will still be visible in reports
          severity: CRITICAL
          scanners: vuln

      - name: Upload Trivy scan results
        if: steps.check.outputs.exists == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/dev'
        continue-on-error: true
        run: |
          echo "üìã Trivy scan completed for ${{ matrix.service }}"
          echo "Security scan results (if generated) are available in the job logs or trivy output artifacts"

  repo-scan:
    name: Repository filesystem & config scans (Trivy)
    runs-on: ubuntu-latest
    needs: maven-build
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin

      - name: Trivy fs scan (repo)
        id: trivy-fs
        run: |
          set -e
          echo "Running trivy fs scan (repo root)"
          trivy fs --format json --output trivy-fs.json --severity CRITICAL,HIGH . || true
          trivy fs --format table --output trivy-fs.txt --severity CRITICAL,HIGH . || true

      - name: Trivy config scan (repo)
        id: trivy-config
        run: |
          set -e
          echo "Running trivy config scan (YAML/Dockerfile/Helm/Terraform)"
          trivy config --format json --output trivy-config.json --severity CRITICAL,HIGH . || true
          trivy config --format table --output trivy-config.txt --severity CRITICAL,HIGH . || true

      - name: Upload trivy repo scan artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-repo-scan
          path: |
            trivy-fs.json
            trivy-fs.txt
            trivy-config.json
            trivy-config.txt
          retention-days: 30

  generate-dev-release:
    name: Generate Dev Release Notes
    # Use a GitHub Environment for dev if you want approvals/secrets scoped to dev
    environment:
      name: dev
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev' && success()
    outputs:
      release_version: ${{ steps.output_info.outputs.version }}
      changelog: ${{ steps.output_info.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Semantic Version & Changelog
        id: version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: dev
          tag_prefix: dev-
          # create the tag at the release generation step
          dry_run: false
          default_bump: minor

      - name: Output Version & Changelog
        id: output_info
        run: |
          echo "version=${{ steps.version.outputs.new_version }}" >> "$GITHUB_OUTPUT"
          echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
          echo "${{ steps.version.outputs.changelog }}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

          # Save changelog to file
          echo "${{ steps.version.outputs.changelog }}" > CHANGELOG_DEV_TEMP.txt

      - name: Create GitHub Pre-Release (Dev)
        if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: dev-${{ steps.output_info.outputs.version }}
          release_name: Dev Release dev-${{ steps.output_info.outputs.version }}
          body: |
            # üîß Dev Release dev-${{ steps.output_info.outputs.version }}

            ## üìù Changelog

            ${{ steps.output_info.outputs.changelog }}

            ## üì¶ Artifacts

            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
            - Author: ${{ github.actor }}
            - Branch: dev

            ## üîó Images (Dev Tag)

            Docker images for this dev release:
            - `ghcr.io/${{ github.repository_owner }}/api-gateway:dev`
            - `ghcr.io/${{ github.repository_owner }}/product-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/user-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/order-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/payment-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/shipping-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/favourite-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/proxy-client:dev`
            - `ghcr.io/${{ github.repository_owner }}/service-discovery:dev`
            - `ghcr.io/${{ github.repository_owner }}/cloud-config:dev`

            ## ‚ö†Ô∏è Development Build

            This is a pre-release development build. Use with caution.

          draft: false
          prerelease: true

      - name: Upload dev changelog as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-release-notes
          path: CHANGELOG_DEV_TEMP.txt
          retention-days: 30

  notify-success-dev:
    name: Notify Success
    runs-on: ubuntu-latest
    if: success()
    needs: [maven-build, docker-build, generate-dev-release]
    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Dev Build Success: ${{ github.repository }}"
          body: |
            The dev build for ${{ github.repository }} has completed successfully! üöÄ

            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Branch: dev

            Check the logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          secure: true

  notify-success:
    name: Notify Failure or Cancellation
    runs-on: ubuntu-latest
    if: failure() || cancelled()
    needs: [maven-build, docker-build, generate-dev-release]
    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Dev Pipeline Failed or Cancelled: ${{ github.repository }}"
          body: |
            The dev pipeline for ${{ github.repository }} has failed or was cancelled.

            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Branch: dev

            Check the logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          secure: true
