name: CI - CD - Dev build

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [dev, "feat/*", "ops/feat/*"]
  pull_request:
    branches: [dev, "feat/*", "ops/feat/*"]

jobs:
  maven-build:
    name: Build (Maven)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Deshabilitado completamente para self-hosted runners
      # El cach√© local del Maven en ~/.m2 ya es persistente en self-hosted
      # - name: Cache Maven local repository
      #   if: runner.environment != 'self-hosted'
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.m2/repository
      #     key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
      #     restore-keys: |
      #       ${{ runner.os }}-m2-

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "11"
          # No usar cache en self-hosted para evitar timeouts

      - name: Build with Maven (run unit tests)
        run: |
          chmod +x ./mvnw
          # Run unit tests. Some modules may not have tests matching the pattern
          # and would cause Maven Surefire to fail the build. Add -DfailIfNoTests=false
          # so that modules without matching tests don't fail the aggregated build.
          ./mvnw -B -T 1C verify -Dtest="*ServiceImplTest" -DfailIfNoTests=false


      - name: SonarQube analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Skip SonarQube analysis in dev environment
          # SonarQube analysis only runs in stage and prod where infrastructure is deployed
          if [ -z "$SONAR_TOKEN" ]; then
            echo "‚è≠Ô∏è  Skipping SonarQube analysis: SONAR_TOKEN not set as secret"
            exit 0
          fi
          echo "‚è≠Ô∏è  SonarQube analysis is disabled for dev environment"
          echo "    (Only runs in stage and prod pipelines)"

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/target/surefire-reports/*.xml
          retention-days: 3

      - name: Upload build workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: |
            .
            !.git
          retention-days: 1

  docker-build:
    name: Build ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: maven-build
    strategy:
      fail-fast: false
      matrix:
        service:
          [
            api-gateway,
            cloud-config,
            favourite-service,
            order-service,
            payment-service,
            product-service,
            proxy-client,
            service-discovery,
            shipping-service,
            user-service,
          ]

    steps:
      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace
          path: .

      - name: Check if Dockerfile exists
        id: check
        run: |
          if [ -f "${{ matrix.service }}/Dockerfile" ]; then 
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else 
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        if: steps.check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      # NOTE: removed conditional push decision; images will be pushed for all branches/PRs with tag 'dev'

      - name: Log in to GHCR
        if: steps.check.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Using fixed tag 'dev' for all pushed images

      - name: Extract metadata
        if: steps.check.outputs.exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=,format=long
            # Add a fixed tag 'dev' for all pushes
            type=raw,value=dev

      - name: Build and push
        if: steps.check.outputs.exists == 'true' && (github.event_name == 'push' && github.ref == 'refs/heads/dev' || github.event_name == 'pull_request' && github.base_ref == 'dev')
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  generate-dev-release:
    name: Generate Dev Release Notes
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev' && success()
    outputs:
      release_version: ${{ steps.output_info.outputs.version }}
      changelog: ${{ steps.output_info.outputs.changelog }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate Semantic Version & Changelog
        id: version
        uses: mathieudutour/github-tag-action@v6.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          release_branches: dev
          tag_prefix: dev-
          dry_run: true
          default_bump: minor

      - name: Output Version & Changelog
        id: output_info
        run: |
          echo "version=${{ steps.version.outputs.new_version }}" >> "$GITHUB_OUTPUT"
          echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
          echo "${{ steps.version.outputs.changelog }}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          
          # Save changelog to file
          echo "${{ steps.version.outputs.changelog }}" > CHANGELOG_DEV_TEMP.txt

      - name: Create GitHub Pre-Release (Dev)
        if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: dev-${{ steps.output_info.outputs.version }}
          release_name: Dev Release dev-${{ steps.output_info.outputs.version }}
          body: |
            # üîß Dev Release dev-${{ steps.output_info.outputs.version }}

            ## üìù Changelog

            ${{ steps.output_info.outputs.changelog }}

            ## üì¶ Artifacts

            - Build Date: ${{ github.event.head_commit.timestamp }}
            - Commit: ${{ github.sha }}
            - Author: ${{ github.actor }}
            - Branch: dev

            ## üîó Images (Dev Tag)

            Docker images for this dev release:
            - `ghcr.io/${{ github.repository_owner }}/api-gateway:dev`
            - `ghcr.io/${{ github.repository_owner }}/product-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/user-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/order-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/payment-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/shipping-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/favourite-service:dev`
            - `ghcr.io/${{ github.repository_owner }}/proxy-client:dev`
            - `ghcr.io/${{ github.repository_owner }}/service-discovery:dev`
            - `ghcr.io/${{ github.repository_owner }}/cloud-config:dev`

            ## ‚ö†Ô∏è Development Build

            This is a pre-release development build. Use with caution.

          draft: false
          prerelease: true

      - name: Upload dev changelog as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dev-release-notes
          path: CHANGELOG_DEV_TEMP.txt
          retention-days: 30

  notify-success-dev:
    name: Notify Success
    runs-on: ubuntu-latest
    if: success()
    needs: [maven-build, docker-build, generate-dev-release]
    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Dev Build Success: ${{ github.repository }}"
          body: |
            The dev build for ${{ github.repository }} has completed successfully! üöÄ
            
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Branch: dev
            
            Check the logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          secure: true

  notify-success:
    name: Notify Failure or Cancellation
    runs-on: ubuntu-latest
    if: failure() || cancelled()
    needs: [maven-build, docker-build, generate-dev-release]
    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Dev Pipeline Failed or Cancelled: ${{ github.repository }}"
          body: |
            The dev pipeline for ${{ github.repository }} has failed or was cancelled.
            
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Branch: dev
            
            Check the logs here: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <${{ secrets.MAIL_USERNAME }}>
          secure: true
